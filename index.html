<!DOCTYPE html>
<html>
    <head>
        <title>Precipitation at Maya sites</title>
        <script type="text/javascript" src="http://mbostock.github.com/d3/d3.min.js"></script>
        <script type="text/javascript" src="http://mbostock.github.com/d3/d3.geo.min.js"></script>
        <script type="text/javascript" src="http://mbostock.github.com/d3/d3.layout.min.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
        <script type="text/javascript" src="https://raw.github.com/bigmlcom/tipsy/master/src/javascripts/jquery.tipsy.js"></script>
        <style type="text/css"> 
.tipsy {
  padding: 5px;
  position: absolute;
  z-index: 100000;
}

.tipsy-inner {
  padding: 5px 8px 4px 8px;
  background-color: #000;
  color: #eee;
  max-width: 200px;
  text-align: center;
}

.tipsy-inner {
  border-radius: 3px;
  -moz-border-radius:3px;
  -webkit-border-radius:3px;
}

.tipsy-arrow {
  position: absolute;
  width: 9px;
  height: 5px;
}

.tipsy-sw .tipsy-arrow { bottom: 0; left: 10px; }
.tipsy-se .tipsy-arrow { bottom: 0; right: 10px; }

body {
  font: 10px sans;
  fill: #222;
  text-rendering: optimizeLegibility;
}
text {
  font: 10px sans;
  fill: #222;
  text-rendering: optimizeLegibility;
}
text.axislabel {
    font-weight: bold;
}

rect {
  stroke: #222;
  stroke-width: 0.5;
}
rect.overlay {
  stroke: none;
  fill-opacity: 0;
}
rect.overlay:hover {
  stroke: #f00;
  stroke-width: 2;
}
rect.selected {
  stroke: #f00;
  stroke-width: 2;
}

path {
  stroke: #222;
  fill: none;
}

circle.site {
  stroke: #222;
  stroke-width: 1;
  fill: #222;
  shape-rendering: optimizeSpeed;
}
circle.site-selected {
  stroke: #f00;
  stroke-width: 3;
  fill: #f00;
  shape-rendering: optimizeSpeed;
}
        </style>
    </head>

    <body>
        <script type="text/javascript">
        function setupHandlers(min, delta, lab, sites, sSites) {
            return function() {
                this.on("click", function(d, i) {
                        var thissites = $.map(d, function(e) { return e; });
                        if(thissites.length > 0) {
                            var idx = sSites.indexOf(thissites[0]);
                            if(idx > -1) {
                                d3.select(this).classed("selected", false);
                                sSites.splice(idx, thissites.length);
                            } else {
                                d3.select(this).classed("selected", true);
                                sSites = sSites.concat(thissites);
                            }
                            lab.html(sSites.length > 0 ?
                                sSites.length + " sites selected" :
                                "");
                            sites.selectAll("circle.site-selected")
                                .classed("site-selected", false);
                            sites.selectAll("circle.site").data(sSites,
                                function(e) {
                                    return e.properties.ObjectID;
                                })
                                .classed("site-selected", true);
                        }
                    })
                    .on("mouseover", function(d, i) {
                        var smin = min + i * delta,
                            smax = min + (i + 1) * delta,
                            num = d3.sum($.map(d, function(e) {
                                    return e.length;
                                }));
                        lab.html(num + " sites <br/>" +
                            "elevation " + smin + " - " + smax + " m");
                    })
                    .on("mouseout", function(d, col) {
                        lab.html(sSites.length > 0 ?
                            sSites.length + " sites selected" : "");
                    });
            }
        }
        function transpose(a) {
            var w = a.length ? a.length : 0,
                    h = a[0] instanceof Array ? a[0].length : 0;
            if(h === 0 || w === 0) { return []; }
            var i, j, t = [];
            for(i=0; i<h; i++) {
                t[i] = [];
                for(j=0; j<w; j++) {
                    t[i][j] = a[j][i];
                }
            }
            return t;
        };
        function nsort(a, b) {
            return a - b;
        }
        function adjLims(min, max) {
            var tmp = Math.pow(10, ('' + max).length - 2),
                tmpmin = min - (min % tmp),
                tmpmax = max - (max % tmp) + tmp;
            return [tmpmin, tmpmax];
        }
        function mkMatrix(l) {
            m = new Array(l);
            for(var i = 0; i < l; i++) {
                m[i] = new Array(l);
                for(var j = 0; j < l; j++) {
                    m[i][j] = new Array();
                }
            }
            return m;
        }
        var proj = d3.geo.mercator().scale(1).translate([0,0]),
            path = d3.geo.path().projection(proj).pointRadius(1),
            margin = 25, s = 30,
            width = window.innerWidth - margin,
            height = window.innerHeight - margin,
            numBins = 10, sSites = new Array(),
            svg = d3.select("body")
                .append("svg:svg")
                .attr("height", height)
                .attr("width", width),
            map = svg.append("svg:g"),
            sites = map.append("svg:g");
        
            d3.json("mesoamerica.geojson", function(json) {
                var bounds0 = d3.geo.bounds(json),
                    bounds = bounds0.map(proj),
                    xscale = width/Math.abs(bounds[1][0] - bounds[0][0]),
                    yscale = height/Math.abs(bounds[1][1] - bounds[0][1]),
                    scale = Math.min(xscale, yscale);

                proj.scale(scale);
                proj.translate(proj([-bounds0[0][0], -bounds0[1][1]]));

                map.append("svg:g").selectAll("path")
                    .data(json.features)
                    .enter().append("svg:path")
                    .attr("d", path);
            d3.json("rain-ele.geojson", function(json) {
                // draw sites
                sites.selectAll("circle")
                    .data(json.features)
                    .enter().append("svg:circle")
                    .attr("r", 1)
                    .attr("cx", function(d) {
                            return proj(d.geometry.coordinates)[0];
                        })
                    .attr("cy", function(d) {
                            return proj(d.geometry.coordinates)[1];
                        })
                    .classed("site", true)
                    .append("original-title").text(function(d) {
                        if(proj(d.geometry.coordinates)[0] > width/2) {
                            $(this).parent().tipsy({gravity:'se'});
                        } else {
                            $(this).parent().tipsy({gravity:'sw'});
                        }
                        return d.properties.name + ": " +
                            d.properties["rain-year"] + " l/m2, " +
                            d.properties["elevation"] + " m";
                    });

                // extract data, get limits
                var rains = $.map(json.features, function(d, i) {
                            return d.properties["rain-year"];
                        }).sort(nsort),
                    elevations = $.map(json.features, function(d, i) {
                        var e = d.properties["elevation"];
                        return e < 0 ? 0 : e;
                    }).sort(nsort),
                    tmp = adjLims(rains[0], rains[rains.length-1]),
                    rmin = tmp[0], rmax = tmp[1],
                    rdelta = (rmax - rmin) / numBins,
                    tmp = adjLims(elevations[0],
                            elevations[elevations.length-1]),
                    emin = tmp[0], emax = tmp[1],
                    edelta = (emax - emin) / numBins,
                    bins = mkMatrix(numBins);

                // populate bins
                $.each(json.features, function(i, d) {
                    var rbin = Math.floor((d.properties["rain-year"] - rmin) /
                                rdelta),
                        e = d.properties["elevation"], e = e < 0 ? 0 : e,
                        ebin = Math.floor((e - emin) / edelta);
                    bins[rbin][ebin].push(d);
                });
                var nmax = d3.max($.map(bins, function(d, i) {
                            return d3.max($.map(d, function(e, j) {
                                    return e.length;
                                }));
                        })),
                    colour = d3.scale.pow().exponent(.3)
                            .domain([0, nmax])
                            .range(["rgb(255,255,255)", "rgb(0,0,0)"]);

                // draw heatmap
                var graph = svg.append("svg:g")
                        .attr("transform", "translate(" +
                            (window.innerWidth - (6 * margin) - (numBins * s)) +
                            ", " + (2 * margin) + ")"),
                    glab = svg.append("svg:foreignObject")
                            .attr("width", 300)
                            .attr("height", 40)
                            .attr("transform", "translate(100,100)")
                            .append("div"),
                    hm = graph.append("svg:g"),
                    hmrows = hm.selectAll("g")
                        .data(bins)
                        .enter().append("svg:g")
                        .attr("transform", function(d, i) {
                                return "translate(0," + (s * i) + ")";
                            });
                hmrows.selectAll("rect")
                    .data(function(d) { return d; })
                    .enter().append("svg:rect")
                    .attr("transform", function(d, i) {
                            return "translate(" + (s * i) + ",0)";
                        })
                    .attr("width", s)
                    .attr("height", s)
                    .attr("fill", function(d) { return colour(d.length); });
                var hmrowso = hm.selectAll("g.overlay")
                        .data(bins)
                        .enter().append("svg:g")
                        .attr("class", "overlay")
                        .property("row", function(d, i) { return i; })
                        .attr("transform", function(d, i) {
                                return "translate(0," + (s * i) + ")";
                            });
                hmrowso.selectAll("rect.overlay")
                    .data(function(d) { return d; })
                    .enter().append("svg:rect")
                    .attr("class", "overlay")
                    .attr("transform", function(d, i) {
                            return "translate(" + (s * i) + ",0)";
                        })
                    .attr("width", s)
                    .attr("height", s)
                    .on("click", function(d, col) {
                        if(d.length > 0) {
                            var row = parseInt(d3.select(d3.event.target
                                    .parentNode).property("row")),
                                idx = sSites.indexOf(d[0]);
                            if(idx > -1) {
                                d3.select(this).classed("selected", false);
                                sSites.splice(idx, d.length);
                            } else {
                                d3.select(this).classed("selected", true);
                                sSites = sSites.concat(d);
                            }
                            glab.html(sSites.length > 0 ?
                                sSites.length + " sites selected" :
                                "");
                            sites.selectAll("circle.site-selected")
                                .classed("site-selected", false);
                            sites.selectAll("circle.site").data(sSites,
                                function(e) {
                                    return e.properties.ObjectID;
                                })
                                .classed("site-selected", true);
                        }
                    })
                    .on("mouseover", function(d, col) {
                        var row = parseInt(d3.select(d3.event.target.parentNode)
                                .property("row")),
                            rsmin = rmin + row * rdelta,
                            rsmax = rmin + (row + 1) * rdelta,
                            esmin = emin + col * edelta,
                            esmax = emin + (col + 1) * edelta;
                        glab.html(d.length + " sites <br/>" +
                            "precipitation " + rsmin + " - " + rsmax +
                            " l/m<sup>2</sup><br/>" + "elevation " + esmin +
                            " - " + esmax + " m");
                    })
                    .on("mouseout", function(d, col) {
                        glab.html(sSites.length > 0 ?
                            sSites.length + " sites selected" : "");
                    });
                // marginal distributions
                var tbins = transpose(bins),
                    rtotmax = d3.max($.map(bins, function(d) {
                                return d3.sum(d.map(function(e) {
                                        return e.length;
                                    }));
                                })),
                    etotmax = d3.max($.map(tbins, function(d) {
                                return d3.sum(d.map(function(e) {
                                        return e.length;
                                    }));
                                })),
                    rsscale = d3.scale.pow().exponent(.5)
                            .domain([0, rtotmax])
                            .range([0, 100]),
                    rcscale = d3.scale.linear()
                            .domain([0, numBins-1])
                            .range(["#aaf", "#00f"]),
                    esscale = d3.scale.pow().exponent(.5)
                            .domain([0, etotmax])
                            .range([0, 100]),
                    ecscale = d3.scale.linear().domain([
                              -32768, 0, 100, 1000, 2000, 3000
                            ]).range([
                              "rgb(30, 120, 30)",
                              "rgb(30, 120, 30)",
                              "rgb(125, 125, 35)",
                              "rgb(100, 25, 25)",
                              "rgb(200, 200, 200)",
                              "rgb(255, 255, 255)"
                          ]),
                    vert = graph.append("svg:g")
                            .attr("transform", "translate(0," +
                                    (s*numBins+s/2) + ")"),
                    hor = graph.append("svg:g")
                            .attr("transform", "translate(" +
                                    (s*numBins+s/2) + ",0)");
                // horizontal
                hor.selectAll("rect")
                    .data(bins).enter()
                    .append("svg:rect")
                    .attr("transform", function(d, i) {
                            return "translate(0," + (s * i) + ")";
                        })
                    .attr("width", function(d) {
                            return rsscale(d3.sum($.map(d, function(e) {
                                    return e.length;
                                })));
                        })
                    .attr("height", s)
                    .attr("fill", function(d, i) { return rcscale(i); });
                hor.selectAll("rect.overlay")
                    .data(bins).enter()
                    .append("svg:rect")
                    .attr("class", "overlay")
                    .attr("transform", function(d, i) {
                            return "translate(0," + (s * i) + ")";
                        })
                    .attr("width", function(d) {
                            return rsscale(d3.sum($.map(d, function(e) {
                                    return e.length;
                                })));
                        })
                    .attr("height", s)
                    .call(setupHandlers(rmin, rdelta, glab, sites, sSites));
                // vertical
                vert.selectAll("rect")
                    .data(tbins).enter()
                    .append("svg:rect")
                    .attr("transform", function(d, i) {
                            return "translate(" + (s * i) + ",0)";
                        })
                    .attr("height", function(d) {
                            return esscale(d3.sum($.map(d, function(e) {
                                    return e.length;
                                })));
                        })
                    .attr("width", s)
                    .attr("fill", function(d, i) { return ecscale(i*edelta); });
                vert.selectAll("rect.overlay")
                    .data(tbins).enter()
                    .append("svg:rect")
                    .attr("class", "overlay")
                    .attr("transform", function(d, i) {
                            return "translate(" + (s * i) + ",0)";
                        })
                    .attr("height", function(d) {
                            return esscale(d3.sum($.map(d, function(e) {
                                    return e.length;
                                })));
                        })
                    .attr("width", s)
                    .call(setupHandlers(emin, edelta, glab, sites, sSites));
                // labels
                for(var i = 0; i <= numBins; i++) {
                    hm.append("svg:text")
                        .attr("transform", "translate(-5," + (s * i) + ")")
                        .attr("text-anchor", "end")
                        .attr("baseline-shift", "-50%")
                        .text(rmin + rdelta * i);
                    hm.append("svg:text")
                        .attr("transform", "translate(" + (s * i) + ",-5)")
                        .attr("text-anchor", "middle")
                        .text(emin + edelta * i);
                }
                hm.append("svg:text")
                    .attr("transform", "translate(-50," + (s*numBins/2) + ")")
                    .attr("text-anchor", "end")
                    .classed("axislabel", true)
                    .text("rain [l/m")
                    .append("svg:tspan")
                    .attr("baseline-shift", "super")
                    .text("2")
                    .append("svg:tspan")
                    .text("]");
                hm.append("svg:text")
                    .attr("transform", "translate(" + (s*numBins/2) + ",-25)")
                    .attr("text-anchor", "middle")
                    .classed("axislabel", true)
                    .text("elevation [m]");
            });
        });
        </script>
    </body>
</html>
