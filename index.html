<!DOCTYPE html>
<html>
    <head>
        <title>Precipitation at Maya sites</title>
        <script type="text/javascript" src="https://raw.github.com/mbostock/d3/master/d3.min.js"></script>
        <script type="text/javascript" src="https://raw.github.com/mbostock/d3/master/d3.geo.min.js"></script>
        <script type="text/javascript" src="https://raw.github.com/mbostock/d3/master/d3.layout.min.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
        <style type="text/css"> 
text {
  font: 10px sans;
  fill: #222;
  shape-rendering: crispEdges;
  text-rendering: optimizeLegibility;
}

polygon.selectormin:hover,
polygon.selectormax:hover {
  fill: #f00;
}
 
rect {
  stroke: #222;
  shape-rendering: crispEdges;
}
 
line {
  stroke: #aaa;
  shape-rendering: crispEdges;
}

button {
  shape-rendering: crispEdges;
  text-rendering: optimizeLegibility;
  background: none;
  margin: 0;
  border: 0;
  min-width: 50px;
  color: #222;
  padding: 6px 10px 6px 10px;
  border-radius: 5px;
}

button:hover {
  background-color: #ccc;
}
button.active {
  background-color: #aaa;
}
        </style>
    </head>

    <body>
        <div id='chart'>
          <button class='active' id='jan'>
            January
          </button><button class='inactive' id='feb'>
            February
          </button><button class='inactive' id='mar'>
            March
          </button><button class='inactive' id='apr'>
            April
          </button><button class='inactive' id='may'>
            May
          </button><button class='inactive' id='jun'>
            June
          </button><button class='inactive' id='jul'>
            July
          </button><button class='inactive' id='aug'>
            August
          </button><button class='inactive' id='sep'>
            September
          </button><button class='inactive' id='oct'>
            October
          </button><button class='inactive' id='nov'>
            November
          </button><button class='inactive' id='dec'>
            December
          </button>
          <p/>
        </div>
        <script type="text/javascript">
        var vis, data, min, max, w = 800, h = 400, bins = 40, delay = 1000,
            xscale, xinterval, yscale, histo, yoffset = 30, ymax,
            minpre = 0, maxpre, maxmove = false, minmove = false, defs,
            yinterval = 200,
            months = [ "jan", "feb", "mar", "apr", "may", "jun", "jul", "aug",
                       "sep", "oct", "nov", "dec" ];
        color = d3.scale.linear().domain([
              -32768, 0, 100, 1000, 2000, 3000
            ]).range([
              "rgb(30, 120, 30)",
              "rgb(30, 120, 30)",
              "rgb(125, 125, 35)",
              "rgb(100, 25, 25)",
              "rgb(200, 200, 200)",
              "rgb(255, 255, 255)"
           ]);
        bar = function() {
            this.attr("x", function(d) { return xscale(d.x); })
                .attr("y", function(d) { return h - yscale(d.y) - yoffset; })
                .attr("fill", function(d) { return "url(#grad" + d.x + ")"; })
                .attr("width", xscale.rangeBand())
                .attr("height", function(d) { return yscale(d.y); });
        }
        profileGrad = function() {
            this.selectAll("stop").remove();
            this.selectAll("stop").data(function(d) { return profileStops(d); })
                .enter()
                .append("svg:stop")
                .attr("offset", function(e) { return e.y + "%"; })
                .attr("stop-color", function(e) { return color(e.elevation); });
        }
        profileStops = function(data) {
            every = Math.round(ymax/h);
            cur = 1;
            vals = $.map(data, function(d, j) {
                    if(cur == 1) {
                        o = new Object;
                        o.x = h.x;
                        o.elevation = d.properties.elevation;
                        cur = every;
                        return o;
                    } else {
                        cur--;
                        return null;
                    }
                });
            vals.sort(function(a, b) {
                    return a.elevation - b.elevation;
                });
            return vals.map(function(d, j) {
                    d.y = j / (vals.length - 1) * 100;
                    return d;
                });
        }
        mkGraph = function(accessor) {
            hist = histo.value(accessor)(data);

            // for some reason d3 won't select "linearGradient"
            defs.selectAll(".gradient")
                .data(hist)
                .enter().append("svg:linearGradient")
                .attr("id", function(d) { return "grad" + d.x; })
                .attr("class", "gradient")
                .attr("x1", "100%")
                .attr("x2", "100%")
                .attr("y1", "100%")
                .attr("y2", "0%")
                .attr("spreadMethod", "pad")
                .call(profileGrad);
            vis.selectAll("rect")
                .data(hist)
                .enter().append("svg:rect").call(bar)
                .append("svg:title")
                .text(function(d) { return d.y + " sites with " + d.x + "l - " +
                        (d.x + xinterval) + "l rain"});
             
        }
        updateGraph = function(accessor) {
            hist = histo.value(accessor)(data);
             
            defs.selectAll(".gradient")
                .data(hist)
                .call(profileGrad);
            vis.selectAll("rect").data(hist)
                .transition()
                .duration(delay)
                .call(bar)
                .select("title")
                .text(function(d) { return d.y + " sites with " + d.x + "l - " +
                        (d.x + xinterval) + "l rain"});
        }

        triangle = function(d) {
            return xscale(d) + "," + (h - yoffset) + " "
                    + (xscale(d) - 5) + "," + (h - yoffset + 10) + " "
                    + (xscale(d) + 5) + "," + (h - yoffset + 10) + " ";
        }

        d3.json("rain-ele.geojson", function(json) {
            data = json.features;
            accessor = function(m) {
                return function(d) {
                    return d.properties["rain-" + m];
                }
            }

            allvals = $.map(json.features, function(d, i) {
                return $.map(months, function(m, j) {
                    return accessor(m)(d);
                });
            });
            min = d3.min(allvals);
            max = d3.max(allvals);
            tmp = Math.pow(10, ('' + max).length - 1);
            tmpmax = 0;
            while(tmpmax < max) {
                tmpmax += tmp;
            }
            max = tmpmax;
             
            chart = d3.select("#chart").append("svg:svg")
                .attr("width", w)
                .attr("height", h);
            defs = chart.append("svg:defs");
            xs = [];
            xinterval = (max - min) / bins;
            for(i = min; i < max; i += xinterval) {
                xs.push(i);
            }
            xs.push(max);
            maxpre = max;
            xscale = d3.scale.ordinal()
                .domain(xs).rangeRoundBands([0, w]);
            chart.append("svg:g").selectAll("text")
                .data(xs)
                .enter().append("svg:text")
                .attr("class", "label")
                .attr("x", function(d) { return xscale(d); })
                .attr("y", function(d) { return d % (2*xinterval) ? h : h - yoffset + 20; })
                .attr("text-anchor", "middle")
                .text(function(d) { return d; });
            chart.append("svg:text")
                .attr("class", "label")
                .attr("x", w)
                .attr("y", max % (2*xinterval) ? h - yoffset/2 : h)
                .attr("text-anchor", "end")
                .style("font-weight", "bold")
                .text("l/m")
                .append("svg:tspan")
                .attr("baseline-shift", "super")
                .text("2");

            histo = d3.layout.histogram().range([min, max]).bins(bins);

            ymax = d3.max($.map(months, function(m, i) {
                        hist = histo.value(accessor(m))(data);
                        return d3.max(hist, function(d) { return d.y });
            }));
            ys = [];
            for(i = 0; i < ymax; i += yinterval) {
                ys.push(i);
            }
            yscale = d3.scale.linear().domain([0, ymax]).range([0, h - yoffset - 10]);
            yaxis = chart.append("svg:g");
            yaxis.selectAll("text")
                .data(ys)
                .enter().append("svg:text")
                .attr("class", "label")
                .attr("x", xscale(max))
                .attr("y", function(d) { return h - yscale(d) - yoffset - 3; })
                .attr("text-anchor", "end")
                .style("font-weight", function(d) { return d > 0 ? "normal" : "bold"; })
                .text(function(d) { return d > 0 ? d : "# sites"; });
            yaxis.selectAll("line")
                .data(ys)
                .enter().append("svg:line")
                .attr("x1", xscale(min))
                .attr("x2", xscale(max))
                .attr("y1", function(d) { return h - yscale(d) - yoffset; })
                .attr("y2", function(d) { return h - yscale(d) - yoffset; });

            selectors = chart.append("svg:g");
            selectors.append("svg:polygon")
                .attr("class", "selectormin")
                .attr("points", triangle(minpre));
            smax = selectors.append("svg:polygon")
                .attr("class", "selectormax")
                .attr("points", triangle(maxpre))
                .on("mousedown", function(d, i) {
                        maxmove = true;
                    });
            d3.select(document).on("mouseup", function(d, i) {
                        maxmove = false;
                   })
            chart.on("mousemove", function(d, i) {
                        if(maxmove) {
                            maxpre = d3.event.clientX - (d3.event.clientX % (xscale.rangeBand() + 1));
                            smax.attr("points", triangle(maxpre));
                        }
                    });

            vis = chart.append("svg:g");
            mkGraph(accessor("jan"));

            $.each(months, function(i, m) {
                d3.select("#" + m).on("click", function() {
                    updateGraph(accessor(m));
                    $.each(months, function(i, m) {
                        $("#" + m).removeClass("active");
                    });
                    $("#" + m).addClass("active");
                });
            });
            $("#jan").addClass("active");
        });
        /*
        var path = d3.geo.path();

        var svg = d3.select("body")
          .append("svg:svg");

        d3.json("rain-ele.geojson", function(json) {
            svg.selectAll("path")
                .data(json.features)
                .enter().append("svg:path")
                .attr("radius", function(f, i) { return 6 - f.rank; })
                .attr("d", path);
        });
        */
        </script>
    </body>
</html>
